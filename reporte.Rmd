---
title: "Reporte GES"
author: "Oficina GES, Hospital Padre Hurtado"
date: "Informe generado el `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    theme: "cerulean"
---

```{r set-options, cache=FALSE, include=FALSE}
options(width = 1000)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	fig.height = 7,
	fig.width = 13,
	message = FALSE,
	warning = FALSE
)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(janitor)
library(readxl)
library(plotly)
library(lubridate)
library(kableExtra)
library(treemap)
library(RColorBrewer)
library(writexl)
library(data.table)
library(scales)
```

```{r message=FALSE, warning=FALSE, include=FALSE}

ges_vigentes <- read_excel("data_raw/vigentes.xlsx", skip = 7) |>
  select(1, 4:8, 10) |> 
  clean_names()
    
ges_vencidas <-read_excel("data_raw/vencidas.xlsx", skip = 7) |>  
  select(6, 1, 4:5, 8:9, 11) |> 
  clean_names()

etapas <- read_excel("tables/listado_etapas_GES.xlsx") |> 
  clean_names() |> 
  mutate(problema_de_salud = str_remove(problema_de_salud, 
                                        pattern ="(\\s?[.]?\\s?[{]\\w+\\s\\w+.\\s?\\d+.?\\d+.)")
         )

total_ges <- rbind(ges_vigentes, ges_vencidas) |> 
  mutate(problema_de_salud = str_remove(problema_de_salud, 
                                        pattern = "(\\s?[.]?\\s?[{]\\w+\\s\\w+.\\s?\\d+.?\\d+.)"),
         fecha_de_inicio = ymd(fecha_de_inicio),
         fecha_limite = ymd(fecha_limite),
         plazo_ges = as.numeric(fecha_limite - fecha_de_inicio),
         dias_avanzados = as.numeric(today() - fecha_de_inicio),
         dias_retraso = ifelse(fecha_limite >= today(), NA_integer_, as.numeric(today() - fecha_limite)),
         plazo_interno = plazo_ges * 0.7,
         fecha_interna = fecha_de_inicio + plazo_interno,
         indice_resolucion = dias_avanzados / plazo_ges,
         riesgo = case_when(
           indice_resolucion > 1 ~ "Vencido",
           indice_resolucion >= 0.7 ~ "Alto",
           indice_resolucion < 0.7 & indice_resolucion >= 0.35 ~ "Medio",
           indice_resolucion < 0.35 ~ "Bajo"
           
         ),
         riesgo = factor(riesgo, levels = c("Bajo", 
                                            "Medio", 
                                            "Alto", 
                                            "Vencido"
                                            )
                         ),
         garantia = case_when(
           indice_resolucion > 1 ~ "Vencido",
           indice_resolucion <= 1 ~ "Vigente"
           )
         )

total_ges <- inner_join(total_ges, etapas) |> 
  mutate(etapa = factor(etapa, levels = c("Consulta", 
                                          "Confirmación", 
                                          "Etapificación", 
                                          "Tratamiento", 
                                          "Rehabilitación", 
                                          "Seguimiento")
                        )
         )
```


```{r message=FALSE, warning=FALSE, include=FALSE}
fecha_vigentes <- read_excel("data_raw/vigentes.xlsx")[1, 1] %>% 
  mutate(corte = dmy(str_extract(`Para Grabar presione F12`, "(\\d+/*\\d+/*\\d+)")))
fecha_vigentes <- fecha_vigentes$corte

fecha_vencidas <- read_excel("data_raw/vencidas.xlsx")[1, 1] %>% 
  mutate(corte = dmy(str_extract(`Para Grabar presione F12`, "(\\d+/*\\d+/*\\d+)")))
fecha_vencidas <- fecha_vencidas$corte

total_ges$corte <- fecha_vencidas

write_xlsx(ges_vigentes, paste0("data_clean/ges_vigentes_", fecha_vigentes, ".xlsx"))
write_xlsx(ges_vencidas, paste0("data_clean/ges_vencidas_", fecha_vencidas, ".xlsx"))
write_xlsx(total_ges, paste0("data_clean/total_ges_", fecha_vencidas, ".xlsx"))
```


```{r echo=FALSE}
total_vencidos <- total_ges |> 
  filter(riesgo == "Vencido") |> 
  dplyr::summarise(n = n())
```

Este informe fue generado a partir de la información disponible en SIGGES.
&nbsp;
&nbsp;

## Total de garantías

Actualmente hay `r nrow(total_ges)` garantías. De ellas, `r total_vencidos` están retrasadas (`r paste0(round(total_vencidos / nrow(total_ges) * 100, 1), "%")`)\

A continuación se muestra la distribución de todas las garantías actualmente abiertas, tanto vigentes como retrasadas.

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
tabla_general <- total_ges |> 
  dplyr::group_by(problema_de_salud, garantia) |> 
  dplyr::summarise(Total = n())

treemap(tabla_general,
        index = "problema_de_salud",
        vSize = "Total",
        type = "index",
        title = "Total de garantías GES",
        palette = "Purples")
```

### Tabla de garantías

```{r echo=FALSE}
DT::datatable(tabla_general, 
              options = list(orderClasses = FALSE), 
              colnames = c("Problema de salud", "Estado", "Total")
              )
```
&nbsp;

## Total de garatías retrasadas

A continuación se muestran la distribución de las garantías retrasadas.

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
tabla_retrasadas <- total_ges |> 
  filter(riesgo == "Vencido") |>  
  dplyr::group_by(problema_de_salud) |> 
  dplyr::summarise(Retrasos = n())

treemap(tabla_retrasadas,
        index = "problema_de_salud",
        vSize = "Retrasos",
        type = "index",
        title = "Total de garantías retrasadas",
        palette = "Blues"
        )
```
&nbsp;

### Tabla de garantías retrasadas

Se incluye la mediana y el máximo de días de retraso para cada patología.

```{r echo=FALSE, paged.print=TRUE}
tabla_vencidos <- total_ges |> 
  filter(riesgo == "Vencido") |> 
  dplyr::group_by(problema_de_salud) |> 
  dplyr::summarise(n = n(),
                   mediana = median(dias_retraso),
                   max = max(dias_retraso)) |> 
  arrange(-n)

DT::datatable(tabla_vencidos, 
              options = list(orderClasses = FALSE), 
              colnames = c("Problema de salud", "N°", "Mediana", "Máximo")
              )

```
&nbsp;

### Días de retraso por paciente y etapa

Mapa de calor en donde colores más oscuros representan número de días más altos (media).

```{r echo=FALSE, fig.height=8.5, fig.width=13, message=FALSE, warning=FALSE, out.width="100%"}
plot_1 <- total_ges |> 
  filter(riesgo == "Vencido") |> 
  dplyr::group_by(problema_de_salud, etapa) |> 
  dplyr::summarise(dias = round(sum(dias_retraso)/ n(), 1)) |> 
  ggplot(aes(etapa, problema_de_salud)) +
  geom_tile(aes(fill = dias)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_1)
```
&nbsp;

### Retraso por paciente y etapa asistencial
  
Días de retraso (media) en sus garantías, agrupados por patología y por la etapa asistencial en la que se encuentran.

```{r echo=FALSE, fig.height=6, fig.width=13, message=FALSE, warning=FALSE, out.width="100%"}
plot_2 <- total_ges |> 
  filter(riesgo == "Vencido") |>  
  dplyr::group_by(problema_de_salud, etapa) |> 
  dplyr::summarise(dias = round(sum(dias_retraso)/ n(), 1),
                   n = n()) |> 
  ggplot(aes(dias, n, 
             text = paste("Problema:", problema_de_salud, "\nN° casos:", n, "\nEspera media:", dias, "días", "\nEtapa:", etapa), 
             color = etapa)) +
  geom_jitter(size = 3) +
  
  scale_color_manual(name = "Tipo de etapa",
                     values = c("#8dd3c7", "#ffed6f", "#bebada", "#fb8072", "#80b1d3", "#fdb462", "#b3de69", "#d9d9d9")) +
  theme_bw() +
  labs(
  x = "Días de espera (media)",
  y = "N° de casos"
  ) 

ggplotly(plot_2, tooltip = "text")
```
&nbsp;

## Análisis por riesgo de vencimiento

Las patologías vigentes están clasificadas en 3 categorías, según su **riesgo de vencimiento**:

-   Riesgo bajo: están dentro del 35% del plazo legal transcurrido.
-   Riesgo medio: están entre el 35% y 70% del plazo legal trancurrido.
-   Riesgo alto: están por sobre el 70% del plazo legal transcurrido.

&nbsp;

### Riesgo por problema de salud

```{r echo=FALSE, fig.height=8.5, fig.width=13, message=FALSE, warning=FALSE, out.width="100%"}
plot_3 <- total_ges |> 
  group_by(problema_de_salud, riesgo) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(riesgo, problema_de_salud)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_3)
```
&nbsp;

### Riesgo por centro de responsabilidad

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
plot_4 <- total_ges |> 
  group_by(centro_responsabilidad, riesgo) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(riesgo, centro_responsabilidad)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_4)
```
&nbsp;

### Riesgo por especialidad

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
plot_5 <- total_ges |> 
  group_by(especialidad, riesgo) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(riesgo, especialidad)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_5)
```
&nbsp;
&nbsp;

## Casos oncológicos

### Por tipo de riesgo

```{r echo=FALSE, message=FALSE, warning=FALSE}
total_onco <- total_ges |> 
  filter(onco == TRUE) |>  
  dplyr::summarise(n = n())

total_onco_retrasadas <- total_ges |> 
  filter(onco == TRUE, garantia == "Vencido") |>  
  dplyr::summarise(n = n())
```

Actualmente hay `r total_onco$n` garantías oncológicas. De ellas, `r total_onco_retrasadas$n` están retrasadas (`r round(total_onco_retrasadas$n / total_onco$n *100, 1)`%).\
Estas se distribuyen de la siguiente forma (retrasadas):  

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
tabla_onco <- total_ges |>
  filter(onco == TRUE) |>  
  dplyr::group_by(riesgo) |>
  dplyr::summarise(n = n())

DT::datatable(tabla_onco, 
              options = list(orderClasses = FALSE), 
              colnames = c("Tipo riesgo", "N°")
              )
```
&nbsp;

### Por tipo de riesgo y área de atención

```{r echo=FALSE, fig.height=5, fig.width=13, message=FALSE, warning=FALSE, out.width="100%"}
plot_6 <- total_ges |> 
  filter(onco == TRUE) |> 
  group_by(riesgo, tipo) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(riesgo, n_casos, fill = tipo)) +
  geom_col() +
  # geom_tile(aes(fill = n_casos)) +
  # scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  scale_fill_manual(name = "Tipo de área", values = c("#cbc9e2", "#756bb1")) +
  theme_bw() +
  labs(
    #title = "Garantías oncológicas por tipo de riesgo",
    x = "",
    y = ""
    ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_6)
```
&nbsp;

### Riesgo por centro de responsabilidad

Se incluyen todas las garantías oncológicas (vigentes por riesgo de vencimiento y retrasadas).

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
plot_7 <- total_ges |> 
  filter(onco == TRUE) %>% 
  group_by(centro_responsabilidad, riesgo) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(riesgo, centro_responsabilidad)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_7)
```
&nbsp;

### Riesgo por patologías oncológicas

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
plot_8 <- total_ges |> 
  filter(onco == TRUE) |> 
  group_by(problema_de_salud, riesgo) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(riesgo, problema_de_salud)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_8) 
```
&nbsp;

### Patologías oncológicas por etapa asistencial (todas)

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
plot_9 <- total_ges |> 
  filter(onco == TRUE) |> 
  group_by(problema_de_salud, etapa) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(etapa, problema_de_salud)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_9)
```
&nbsp;

### Patologías oncológicas por etapa asistencial (retrasadas)

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
plot_10 <- total_ges |> 
  filter(onco == TRUE, riesgo == "Vencido") |> 
  group_by(problema_de_salud, etapa) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(etapa, problema_de_salud)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_10)
```
&nbsp;

### Días de retraso por paciente y etapa asistencial

Días de retraso (media) en sus garantías, agrupados por patología oncológica y por la etapa asistencial en la que se encuentran.

```{r echo=FALSE, fig.height=6, fig.width=13, message=FALSE, warning=FALSE, out.width="100%"}
plot_11 <- total_ges |> 
  filter(riesgo == "Vencido", onco == TRUE) |>  
  dplyr::group_by(problema_de_salud, etapa) |> 
  dplyr::summarise(dias = round(sum(dias_retraso)/ n(), 1),
                   n = n()) |> 
  ggplot(aes(dias, n, 
             text = paste("Problema:", problema_de_salud, "\nN° casos:", n, "\nEspera media:", dias, "días", "\nEtapa:", etapa), 
             color = etapa)) +
  geom_jitter(size = 3) +
  
  scale_color_manual(name = "Tipo de etapa",
                     values = c("#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3")) +
  theme_bw() +
  labs(
  x = "Días de espera (media)",
  y = "N° de casos"
  ) 

ggplotly(plot_11, tooltip = "text")
```
&nbsp;

### Evolución garantías retrasadas oncológicas

```{r echo=FALSE, message=FALSE, warning=FALSE}
temp <- list.files(path = "./data_clean/",
               pattern = "total_ges*", 
               full.names = TRUE) %>% 
    map_df(~read_excel(.))

integer_breaks <- function(n = 5, ...) {
  fxn <- function(x) {
    breaks <- floor(pretty(x, n, ...))
    names(breaks) <- attr(breaks, "labels")
    breaks
  }
  return(fxn)
}
```
&nbsp;

#### Todas las garantías

A continuación se muestra la evolución en el tiempo del número de garantías retrasadas oncológicas.

```{r echo=FALSE,fig.height=4.5, message=FALSE, warning=FALSE, out.width="100%"}
plot_12 <- temp %>% 
  mutate(corte = ymd(corte)) %>% 
  filter(garantia == "Vencido", onco == TRUE) %>% 
  dplyr::group_by(corte) %>% 
  dplyr::summarise(n = n()) %>% 
  ggplot(aes(corte, n)) +
  geom_line(size = 1.5, color = "#cbc9e2") +
  geom_point(size= 2, color = "#756bb1") +
  scale_y_continuous(breaks = integer_breaks()) + 
  scale_x_date(date_labels = "%b %d") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(
    #title = "Todas las garantías retrasadas",
    x = "",
    y = "N° garantías retrasadas"
  )

ggplotly(plot_12)
```
&nbsp;

#### Garantías por tipo de atención

Evolución en el tiempo de las grantías oncológicas retrasadas, dividadas por tipo de atención.

```{r echo=FALSE,fig.height=4.5, message=FALSE, warning=FALSE, out.width="100%"}
plot_13 <- temp %>% 
  mutate(corte = ymd(corte)) %>% 
  filter(garantia == "Vencido", onco == TRUE) %>% 
  dplyr::group_by(corte, tipo) %>% 
  dplyr::summarise(n = n()) %>% 
  ggplot(aes(corte, n, color = tipo)) +
  geom_line(size = 1.5) +
  geom_point(size= 2) +
  scale_y_continuous(breaks = integer_breaks()) + 
  scale_x_date(date_labels = "%b %d") +
  scale_color_manual(name = "Tipo de atención",
                     values = c("#cbc9e2", "#756bb1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    #title = "Todas las garantías retrasadas",
    x = "",
    y = "N° garantías retrasadas"
  )

ggplotly(plot_13)
```
&nbsp;

#### Garantías ambulatorias por patología

```{r echo=FALSE,fig.height=4.5, message=FALSE, warning=FALSE, out.width="100%"}
plot_14 <- temp %>% 
  mutate(corte = ymd(corte)) %>% 
  filter(garantia == "Vencido", onco == TRUE, tipo == "Ambulatorio") %>% 
  dplyr::group_by(tipo, problema_de_salud, corte) %>% 
  dplyr::summarise(n = n()) %>% 
  ggplot(aes(corte, n, color = problema_de_salud)) +
  geom_line(size = 0.7) +
  geom_point(size = 1.2) +
  scale_y_continuous(breaks = integer_breaks()) + 
  scale_x_date(date_labels = "%b %d") +
  #scale_color_brewer(palette = "Accent") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(
    #title = "Ambulatorias",
    x = "",
    y = "N° garantías retrasadas"
  )

ggplotly(plot_14)
```
&nbsp;

#### Garantías quirúrgicas por patología

```{r echo=FALSE, fig.height=4.5, message=FALSE, warning=FALSE, out.width="100%"}
plot_15 <- temp %>% 
  mutate(corte = ymd(corte)) %>% 
  filter(garantia == "Vencido", onco == TRUE, tipo == "Quirúrgico") %>% 
  dplyr::group_by(tipo, problema_de_salud, corte) %>% 
  dplyr::summarise(n = n()) %>% 
  ggplot(aes(corte, n, color = problema_de_salud)) +
  geom_line(size = 0.7) +
  geom_point(size = 1.2) +
  scale_y_continuous(breaks = integer_breaks()) + 
  scale_x_date(date_labels = "%b %d") +
  #scale_color_brewer(palette = "Accent") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right") +
  labs(
    #title = "Quirúrgicas",
    x = "",
    y = "N° garantías retrasadas"
  )

ggplotly(plot_15)
```

&nbsp;
&nbsp;

## Por área de atención

### Patologías ambulatorias

```{r echo=FALSE, fig.height=7.5, message=FALSE, warning=FALSE, out.width="100%"}
plot_16 <- total_ges |> 
  filter(tipo == "Ambulatorio") |> 
  group_by(problema_de_salud, riesgo) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(riesgo, problema_de_salud)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_16)
```
&nbsp;

### Patologías quirúrgicas

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%"}
plot_17 <- total_ges |> 
  filter(tipo == "Quirúrgico") |> 
  group_by(problema_de_salud, riesgo) |> 
  summarise(n_casos = n()) |> 
  ggplot(aes(riesgo, problema_de_salud)) +
  geom_tile(aes(fill = n_casos)) +
  scale_fill_gradient(low = "#efedf5", high = "#54278f") +
  theme_bw() +
  labs(
  x = "",
  y = ""
  ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(plot_17)
```



------------------------------------------------------------------------

Puedes revisar el código de este reporte en el [siguiente repositorio](https://github.com/paulovillarroel/reporte_GES).\
Diseñado por Paulo Villarroel.
